from typing import Dict, Any, Tuple
import numpy as np
from scipy import stats
from ..adapters.base import GraphAdapter
from .inference import calculate_density

def z_test_density(adapter: GraphAdapter, expected_density: float, n_nodes: int) -> Tuple[float, float]:
    """
    Perform a Z-test comparing the graph's density to an expected density (e.g., from a null model).
    
    Args:
        adapter: GraphAdapter instance
        expected_density: The density of the null model (p)
        n_nodes: Number of nodes in the graph (N)
        
    Returns:
        Tuple of (z_score, p_value)
    """
    # Observed density
    observed_density = calculate_density(adapter)
    
    # Total possible edges
    m_max = n_nodes * (n_nodes - 1) / 2
    
    # Standard Error for density (assuming binomial distribution of edges)
    # SE = sqrt(p * (1-p) / M_max)
    std_error = np.sqrt(expected_density * (1 - expected_density) / m_max)
    
    if std_error == 0:
        return 0.0, 1.0
        
    z_score = (observed_density - expected_density) / std_error
    p_value = 2 * (1 - stats.norm.cdf(abs(z_score)))  # Two-tailed test
    
    return z_score, p_value
