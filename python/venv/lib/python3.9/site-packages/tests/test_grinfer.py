import unittest
from unittest.mock import MagicMock
from hypograph.adapters.cypher_adapter import CypherAdapter
from hypograph.stats.inference import calculate_density

class TestHypograph(unittest.TestCase):
    def test_cypher_adapter_mock(self):
        adapter = CypherAdapter()
        adapter.driver = MagicMock()
        session = MagicMock()
        adapter.driver.session.return_value.__enter__.return_value = session
        
        # Mock result
        record = MagicMock()
        record.data.return_value = {'n': {'id': 1}}
        session.run.return_value = [record]
        
        result = adapter.query("MATCH (n) RETURN n")
        self.assertEqual(len(result), 1)
        self.assertEqual(result[0]['n']['id'], 1)

    def test_calculate_density(self):
        adapter = MagicMock()
        # Mock node count = 4, edge count = 3
        # Density = 2*3 / (4*3) = 6/12 = 0.5
        
        def query_side_effect(query, params=None):
            if "count(n)" in query:
                return [{'count': 4}]
            if "count(r)" in query:
                return [{'count': 3}]
            return []
            
        adapter.query.side_effect = query_side_effect
        
        density = calculate_density(adapter)
        self.assertEqual(density, 0.5)

if __name__ == '__main__':
    unittest.main()
